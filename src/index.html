<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>CanvasToMP4</title>
    <link rel="icon" href="favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script type="application/javascript" src="build/EventDispatcher.js"></script>
    <script type="application/javascript" src="build/three.min.js"></script>
    <script type="application/javascript" src="build/gl-matrix.js"></script>

    <script type="application/javascript" src="build/canvasToMp4/FFmpegCommand.js"></script>
    <script type="application/javascript" src="build/canvasToMp4/FFMpegCaptureManager.js"></script>

    <script type="application/javascript" src="build/holoplay/HoloAppType.js"></script>
    <script type="application/javascript" src="build/holoplay/HoloMultiViewRenderer.js"></script>
    <script type="application/javascript" src="build/holoplay/HoloScreen.js"></script>
    <script type="application/javascript" src="build/holoplay/HoloEppRom.js"></script>
    <script type="application/javascript" src="build/holoplay/Holoplay.js"></script>
    <script type="application/javascript" src="build/holoplay/HoloplayApp.js"></script>
    <script type="text/javascript" src="build/Test.js"></script>

    <style>
    *{
      padding:0;
      margin:0;
      overflow: hidden;
    }
    </style>
    <script type="text/javascript">

      var demo;
      var encoder;

      function startApp(){

        var quilt = {
          width:16384,
          height:16384,
          nbX:8,
          nbY:8
        }

        var ffmpegConfig = {
          width:2560,
          height:1600,
          fps:60,
          durationInSeconds:1,
          fileName:"videos/output.mp4",
          encoderType:"h264_nvenc",
          verticalFlip:true
        }


        var createQuiltVideo = false
        var mode = HoloAppType.HOLOGRAM_VIDEO_ENCODER;

        if(createQuiltVideo){
          ffmpegConfig.width = quilt.width;
          ffmpegConfig.height = quilt.height;
          mode = HoloAppType.QUILT_VIDEO_ENCODER;
        }

        demo = new Test(quilt,mode);

        demo.nextFrame = function(pct){
          this.fieldOfVision = 60;
          this.parallaxRatio = 0.5;
          this.update();
        }

        //---------------
        var progressBar = document.createElement("canvas");
        document.body.appendChild(progressBar);
        var ctx = progressBar.getContext("2d");
        var w = progressBar.width = window.innerWidth;
        var h = progressBar.height = window.innerHeight;
        ctx.fillStyle = "#000000";
        ctx.font = "20px Arial";
        ctx.fillText("capture started - please wait... -",20,20);

        function updateProgressBar(){
          ctx.clearRect(0,0,w,h);
          ctx.fillStyle = "#66de66";
          ctx.fillRect(0,0,w * encoder.encodingProgress,h);
        }


        encoder = new FFMpegCaptureManager(new FFmpegCommand(ffmpegConfig));
        encoder.addEventListener(FFMpegCaptureManager.FRAME_CAPTURED,function(e){
           //document.body.innerText += "Frame capture : "+encoder.nbFrameCaptured+" / "+encoder.nbFrameTotal+"\n";
           updateProgressBar();
         })
        encoder.addEventListener(FFMpegCaptureManager.FILE_CREATION_COMPLETED,function(e){
           console.log("FILE CREATED")
           ctx.clearRect(0,0,w,h);
           ctx.fillStyle = "#000000";
           ctx.font = "20px Arial";
           ctx.fillText("File created",20,20);
           //document.body.innerText += "FILE CREATED !";
         })
        encoder.addEventListener(FFMpegCaptureManager.FRAME_ENCODED,function(e){
          console.log("encodingProgress = ",encoder.encodingProgress)
          updateProgressBar();
          //document.body.innerText += "encoding progress = "+Math.floor(encoder.encodingProgress * 100)+" % \n";
        })


        demo.onReady = function(){


          //document.body.innerText += "Connected to the looking glass ! \n";
          //document.body.innerText += "Encoding start.  \n";
          encoder.start(demo,"nextFrame")
        }

      }

    </script>
</head>
<body onload="startApp()">

</body>
</html>
